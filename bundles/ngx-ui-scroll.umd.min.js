!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("rxjs"),require("rxjs/operators"),require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("ngx-ui-scroll",["exports","rxjs","rxjs/operators","@angular/core","@angular/common"],factory):factory((global.ng=global.ng||{},global.ng.ngxUiScroll={}),global.rxjs,global.rxjs.operators,global.ng.core,global.ng.common)}(this,function(exports,rxjs,operators,core,common){"use strict";var __assign=function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)},assignBoolean=function(target,source,token,defaults){var param=source[token];if(void 0!==param){if("boolean"==typeof param)return target[token]=param,!0;console.warn(token+" setting parse error, set it to "+defaults[token]+" (default)")}},assignNumeric=function(target,source,token,defaults,integer){void 0===integer&&(integer=!1);var param=source[token];if(void 0!==param)if("number"==typeof param){if(!integer||parseInt(param.toString(),10)===param)return target[token]=param,!0;console.warn(token+" setting parse error, set it to "+defaults[token]+" (default)")}else console.warn(token+" setting parse error, set it to "+defaults[token]+" (default)")},assignMinimalNumeric=function(target,source,token,defaults,minSettings,integer,mustExist){if(void 0===integer&&(integer=!1),void 0===mustExist&&(mustExist=!0),!0===assignNumeric(target,source,token,defaults,integer)||mustExist)return!(target[token]<minSettings[token])||(console.warn(token+" setting is less than minimum, set it to "+minSettings[token]),void(target[token]=minSettings[token]))},assignCommon=function(target,settings,defaults){Object.assign(target,defaults),void 0!==settings&&("object"==typeof settings||console.warn("settings is not an object, fallback to the defaults"))},Direction_forward="forward",Direction_backward="backward",Process_init="init",Process_scroll="scroll",Process_reload="reload",Process_start="start",Process_preFetch="preFetch",Process_fetch="fetch",Process_postFetch="postFetch",Process_render="render",Process_clip="clip",Process_adjust="adjust",Process_end="end",ProcessStatus_start="start",ProcessStatus_next="next",ProcessStatus_done="done",ProcessStatus_error="error",getInitializedSubject=function(adapter,method){return adapter.init?method():adapter.init$.pipe(operators.switchMap(function(){return method()}))},itemAdapterEmpty={data:{},element:{}},Adapter=function(){function Adapter(){this.isInitialized=!1}return Object.defineProperty(Adapter.prototype,"init",{get:function(){return this.isInitialized},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"init$",{get:function(){return adapter=this,rxjs.Observable.create(function(observer){var intervalId=setInterval(function(){adapter&&adapter.init&&(clearInterval(intervalId),observer.next(!0),observer.complete())},25)});var adapter},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"version",{get:function(){return this.isInitialized?this.getVersion():null},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"isLoading",{get:function(){return!!this.isInitialized&&this.getIsLoading()},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"isLoading$",{get:function(){var _this=this;return getInitializedSubject(this,function(){return _this.getIsLoading$()})},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"loopPending",{get:function(){return!!this.isInitialized&&this.getLoopPending()},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"loopPending$",{get:function(){var _this=this;return getInitializedSubject(this,function(){return _this.getLoopPending$()})},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"cyclePending",{get:function(){return!!this.isInitialized&&this.getCyclePending()},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"cyclePending$",{get:function(){var _this=this;return getInitializedSubject(this,function(){return _this.getCyclePending$()})},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"firstVisible",{get:function(){return this.isInitialized?this.getFirstVisible():{}},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"firstVisible$",{get:function(){var _this=this;return getInitializedSubject(this,function(){return _this.getFirstVisible$()})},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"lastVisible",{get:function(){return this.isInitialized?this.getLastVisible():{}},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"lastVisible$",{get:function(){var _this=this;return getInitializedSubject(this,function(){return _this.getLastVisible$()})},enumerable:!0,configurable:!0}),Object.defineProperty(Adapter.prototype,"itemsCount",{get:function(){return this.isInitialized?this.getItemsCount():0},enumerable:!0,configurable:!0}),Adapter.prototype.initialize=function(scroller){if(!this.isInitialized){var state=(this.scroller=scroller).state,buffer=scroller.buffer;this.isInitialized=!0,this.callWorkflow=scroller.callWorkflow,this.getVersion=function(){return scroller.version},this.getIsLoading=function(){return state.isLoading},this.getIsLoading$=function(){return state.isLoadingSource},this.getLoopPending=function(){return state.loopPending},this.getLoopPending$=function(){return state.loopPendingSource},this.getCyclePending=function(){return state.workflowPending},this.getCyclePending$=function(){return state.workflowPendingSource},this.getItemsCount=function(){return buffer.getVisibleItemsCount()},this.initializeProtected(scroller)}},Adapter.prototype.initializeProtected=function(scroller){var state=scroller.state,getFirstVisibleProtected=function(){return getFirstVisibleProtected=function(){return state.firstVisibleItem},state.firstVisibleWanted=!0,state.firstVisibleItem},getFirstVisible$Protected=function(){return getFirstVisible$Protected=function(){return state.firstVisibleSource},state.firstVisibleWanted=!0,state.firstVisibleSource},getLastVisibleProtected=function(){return getLastVisibleProtected=function(){return state.lastVisibleItem},state.lastVisibleWanted=!0,state.lastVisibleItem},getLastVisible$Protected=function(){return getLastVisible$Protected=function(){return state.lastVisibleSource},state.lastVisibleWanted=!0,state.lastVisibleSource};this.getFirstVisible=function(){return getFirstVisibleProtected()},this.getFirstVisible$=function(){return getFirstVisible$Protected()},this.getLastVisible=function(){return getLastVisibleProtected()},this.getLastVisible$=function(){return getLastVisible$Protected()}},Adapter.prototype.reload=function(reloadIndex){this.scroller.logger.log(function(){return"adapter: reload("+reloadIndex+")"}),this.callWorkflow({process:Process_reload,status:ProcessStatus_start,payload:reloadIndex})},Adapter.prototype.showLog=function(){this.scroller.logger.logForce()},Adapter.prototype.setScrollPosition=function(value){this.scroller.logger.log(function(){return"adapter: setScrollPosition("+value+")"}),Number(value)!==parseInt(value,10)?this.scroller.logger.log(function(){return"can't set scroll position because "+value+" is not an integer"}):(this.scroller.state.syntheticScroll.reset(),this.scroller.viewport.setPosition(value))},Adapter.prototype.setMinIndex=function(value){this.scroller.logger.log(function(){return"adapter: setMinIndex("+value+")"});var index=Number(value);isNaN(index)?this.scroller.logger.log(function(){return"can't set minIndex because "+value+" is not a number"}):this.scroller.buffer.minIndexUser=index},Adapter}(),Datasource=function(datasource,hasNoAdapter){this.constructed=!0,Object.assign(this,datasource),this.adapter=hasNoAdapter?{version:null,init:!1,init$:rxjs.of(!1),isLoading:!1,isLoading$:new rxjs.BehaviorSubject(!1),cyclePending:!1,cyclePending$:new rxjs.BehaviorSubject(!1),loopPending:!1,loopPending$:new rxjs.BehaviorSubject(!1),firstVisible:itemAdapterEmpty,firstVisible$:new rxjs.BehaviorSubject(itemAdapterEmpty),lastVisible:itemAdapterEmpty,lastVisible$:new rxjs.BehaviorSubject(itemAdapterEmpty),itemsCount:0,initialize:function(){return null},reload:function(){return null},showLog:function(){return null},setMinIndex:function(){return null},setScrollPosition:function(){return null}}:new Adapter},defaultSettings={adapter:!1,startIndex:1,minIndex:-1/0,maxIndex:1/0,bufferSize:5,padding:.5,infinite:!1,horizontal:!1,windowViewport:!1},minSettings={itemSize:1,bufferSize:1,padding:.01},defaultDevSettings={debug:!1,immediateLog:!0,logTime:!1,throttle:40,inertia:!1,inertiaScrollDelay:125,inertiaScrollDelta:35,initDelay:1,initWindowDelay:40,maxSynthScrollDelay:450},minDevSettings={throttle:0,inertiaScrollDelay:0,inertiaScrollDelta:0,initDelay:0,initWindowDelay:0,maxSynthScrollDelay:0},Settings=function(){function Settings(settings,devSettings,instanceIndex){!function(target,settings,defaults,minSettings){assignCommon(target,settings,defaults),assignBoolean(target,settings,"adapter",defaults),assignNumeric(target,settings,"startIndex",defaults),assignNumeric(target,settings,"minIndex",defaults),assignNumeric(target,settings,"maxIndex",defaults),assignMinimalNumeric(target,settings,"itemSize",defaults,minSettings,!0,!1),assignMinimalNumeric(target,settings,"bufferSize",defaults,minSettings,!0),assignMinimalNumeric(target,settings,"padding",defaults,minSettings),assignBoolean(target,settings,"infinite",defaults),assignBoolean(target,settings,"horizontal",defaults),assignBoolean(target,settings,"windowViewport",defaults)}(this,settings||{},defaultSettings,minSettings),function(target,devSettings,defaults,minDevSettings){assignCommon(target,devSettings,defaults),assignBoolean(target,devSettings,"debug",defaults),assignBoolean(target,devSettings,"immediateLog",defaults),assignBoolean(target,devSettings,"logTime",defaults),assignMinimalNumeric(target,devSettings,"throttle",defaults,minDevSettings,!0),assignBoolean(target,devSettings,"inertia",defaults),assignMinimalNumeric(target,devSettings,"inertiaScrollDelay",defaults,minDevSettings,!0),assignMinimalNumeric(target,devSettings,"inertiaScrollDelta",defaults,minDevSettings,!0),assignMinimalNumeric(target,devSettings,"initDelay",defaults,minDevSettings,!0),assignMinimalNumeric(target,devSettings,"initWindowDelay",defaults,minDevSettings,!0),assignMinimalNumeric(target,devSettings,"maxSynthScrollDelay",defaults,minDevSettings,!0)}(this,devSettings||{},defaultDevSettings,minDevSettings),this.instanceIndex=instanceIndex,this.initializeDelay=this.getInitializeDelay()}return Settings.prototype.getInitializeDelay=function(){var result=0;return!this.windowViewport||!this.initWindowDelay||"scrollRestoration"in history||(result=this.initWindowDelay),0<this.initDelay&&(result=Math.max(result,this.initDelay)),result},Settings}(),Logger=function(){function Logger(scroller){this.logs=[];var settings=scroller.settings;this.debug=settings.debug,this.immediateLog=settings.immediateLog,this.logTime=settings.logTime,this.getTime=function(){return scroller.state&&" // time: "+scroller.state.time},this.getStat=function(){var buffer=scroller.buffer,viewport=scroller.viewport,first=buffer.getFirstVisibleItem(),last=buffer.getLastVisibleItem();return"pos: "+viewport.scrollPosition+", size: "+viewport.getScrollableSize()+", bwd_p: "+viewport.paddings.backward.size+", fwd_p: "+viewport.paddings.forward.size+", aver: "+(buffer.hasItemSize?buffer.averageSize:"no")+", items: "+buffer.getVisibleItemsCount()+", range: "+(first&&last?"["+first.$index+".."+last.$index+"]":"no")},this.getFetchRange=function(){var _a=scroller.state.fetch,firstIndex=_a.firstIndex,lastIndex=_a.lastIndex;return null!==firstIndex&&null!==lastIndex&&!isNaN(firstIndex)&&!isNaN(lastIndex)?"["+firstIndex+".."+lastIndex+"]":"no"},this.getInnerLoopCount=function(){return scroller.state.innerLoopCount},this.getWorkflowCycleData=function(more){return scroller.settings.instanceIndex+"-"+scroller.state.workflowCycleCount+(more?"-":"")},this.log(function(){return"uiScroll Workflow has been started (v"+scroller.version+", instance "+settings.instanceIndex+")"})}return Logger.prototype.object=function(str,obj,stringify){this.log(function(){return[str,stringify?JSON.stringify(obj).replace(/"/g,"").replace(/(\{|\:|\,)/g,"$1 "):obj]})},Logger.prototype.stat=function(str){var _this=this;if(this.debug){var logStyles_1=["color: #888; border: dashed #888 0; border-bottom-width: 0px","color: #000; border-width: 0"];this.log(function(){return["%cstat"+(str?" "+str:"")+",%c "+_this.getStat()].concat(logStyles_1)})}},Logger.prototype.fetch=function(str){var _this=this;if(this.debug){var _text_1="fetch interval"+(str?" "+str:""),logStyles_2=["color: #888","color: #000"];this.log(function(){return["%c"+_text_1+": %c"+_this.getFetchRange()].concat(logStyles_2)})}},Logger.prototype.logProcess=function(data){if(this.debug){var process=data.process,status=data.status,payload=data.payload||{empty:!0},processLog="process "+process+", %c"+status+"%c"+(payload.empty?"":","),styles=[status===ProcessStatus_error?"color: #cc0000;":"","color: #000000;"];this.log(function(){return[processLog].concat(styles,payload.empty?[]:[payload])});var workflowCycleData=this.getWorkflowCycleData(!0),loopCount=this.getInnerLoopCount(),loopLog=[];if(process===Process_init&&status===ProcessStatus_next||process===Process_scroll&&status===ProcessStatus_next&&payload.keepScroll||process===Process_end&&status===ProcessStatus_next&&payload.byTimer?loopLog.push("%c---=== loop "+(workflowCycleData+(loopCount+1))+" start"):process!==Process_end||payload.byTimer||(loopLog.push("%c---=== loop "+(workflowCycleData+loopCount)+" done"),status!==ProcessStatus_next||payload.keepScroll||(loopLog[0]+=", loop "+(workflowCycleData+(loopCount+1))+" start")),loopLog.length&&this.log(function(){return loopLog.concat(["color: #006600;"])}),process===Process_init&&status===ProcessStatus_start||process===Process_reload&&status===ProcessStatus_next||process===Process_scroll&&status===ProcessStatus_next&&!payload.keepScroll){var logData_1=this.getWorkflowCycleData(!1);this.log(function(){return["%c   ~~~ WF Cycle "+logData_1+" STARTED ~~~  ","color: #0000aa; border: solid black 1px; border-width: 1px 0 0 1px; margin-left: -2px"]})}if(process===Process_end&&status===ProcessStatus_done){var logData_2=this.getWorkflowCycleData(!1);this.log(function(){return["%c   ~~~ WF Cycle "+logData_2+" FINALIZED ~~~  ","color: #0000aa; border: solid #555 1px; border-width: 0 0 1px 1px; margin-left: -2px"]})}}},Logger.prototype.log=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];if(this.debug){if("function"==typeof args[0]&&(args=args[0](),Array.isArray(args)||(args=[args])),args.every(function(item){return void 0===item}))return;this.logTime&&(args=args.concat([this.getTime()])),this.immediateLog?console.log.apply(this,args):this.logs.push(args)}},Logger.prototype.logForce=function(){for(var _this=this,args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this.debug&&(!this.immediateLog&&this.logs.length&&(this.logs.forEach(function(logArgs){return console.log.apply(_this,logArgs)}),this.logs=[]),args.length&&console.log.apply(this,args))},Logger}(),Routines=function(){function Routines(settings){this.horizontal=settings.horizontal}return Routines.prototype.getScrollPosition=function(element){return element[this.horizontal?"scrollLeft":"scrollTop"]},Routines.prototype.setScrollPosition=function(element,value){element[this.horizontal?"scrollLeft":"scrollTop"]=value},Routines.prototype.getParams=function(element){return"body"===element.tagName.toLowerCase()?{height:(element=element.parentElement).clientHeight,width:element.clientWidth,top:element.clientTop,bottom:element.clientTop+element.clientHeight,left:element.clientLeft,right:element.clientLeft+element.clientWidth}:element.getBoundingClientRect()},Routines.prototype.getSize=function(element){return this.getParams(element)[this.horizontal?"width":"height"]},Routines.prototype.getSizeStyle=function(element){var size=element.style[this.horizontal?"width":"height"];return parseInt(size,10)||0},Routines.prototype.setSizeStyle=function(element,value){element.style[this.horizontal?"width":"height"]=value+"px"},Routines.prototype.getRectEdge=function(params,direction,opposite){return params[direction===(opposite?Direction_backward:Direction_forward)?this.horizontal?"right":"bottom":this.horizontal?"left":"top"]},Routines.prototype.getEdge=function(element,direction,opposite){var params=this.getParams(element);return this.getRectEdge(params,direction,opposite)},Routines.prototype.getEdge2=function(element,direction,relativeElement,opposite){return element.offsetTop-(relativeElement?relativeElement.scrollTop:0)+(direction===(opposite?Direction_backward:Direction_forward)?this.getSize(element):0)},Routines.prototype.hideElement=function(element){element.style.display="none"},Routines.prototype.getOffset=function(element){return this.horizontal?element.offsetLeft:element.offsetTop},Routines}(),Padding=function(){function Padding(element,direction,routines){this.element=element.querySelector("[data-padding-"+direction+"]"),this.direction=direction,this.routines=routines}return Padding.prototype.reset=function(size){this.size=size||0},Object.defineProperty(Padding.prototype,"size",{get:function(){return this.routines.getSizeStyle(this.element)},set:function(value){this.routines.setSizeStyle(this.element,Math.round(value))},enumerable:!0,configurable:!0}),Padding}(),Paddings=function(){function Paddings(element,routines,settings){this.settings=settings,this.forward=new Padding(element,Direction_forward,routines),this.backward=new Padding(element,Direction_backward,routines)}return Paddings.prototype.reset=function(viewportSize,startIndex){this.forward.reset(this.getPositiveSize(startIndex,viewportSize)),this.backward.reset(this.getNegativeSize(startIndex))},Paddings.prototype.getPositiveSize=function(startIndex,viewportSize){var settings=this.settings,positiveSize=viewportSize;return isFinite(settings.maxIndex)&&(positiveSize=(settings.maxIndex-startIndex+1)*settings.itemSize),positiveSize},Paddings.prototype.getNegativeSize=function(startIndex){var settings=this.settings,negativeSize=0;return isFinite(settings.minIndex)&&(negativeSize=(startIndex-settings.minIndex)*settings.itemSize),negativeSize},Paddings}(),Viewport=function(){function Viewport(elementRef,settings,routines,state,logger){this.settings=settings,this.routines=routines,this.state=state,this.logger=logger,this.element=elementRef.nativeElement,settings.windowViewport?(this.host=this.element.ownerDocument.body,this.scrollEventElement=this.element.ownerDocument,this.scrollable=this.scrollEventElement.scrollingElement):(this.host=this.element.parentElement,this.scrollEventElement=this.host,this.scrollable=this.element.parentElement),this.paddings=new Paddings(this.element,this.routines,settings),settings.windowViewport&&"scrollRestoration"in history&&(history.scrollRestoration="manual")}return Viewport.prototype.reset=function(scrollPosition){var newPosition=0;this.paddings.reset(this.getSize(),this.state.startIndex);var negativeSize=this.paddings.backward.size;negativeSize&&(newPosition=negativeSize,this.state.bwdPaddingAverageSizeItemsCount=negativeSize/this.settings.itemSize),this.scrollPosition=newPosition,this.state.scrollState.reset(),this.state.syntheticScroll.reset(scrollPosition!==newPosition?newPosition:null),this.startDelta=0},Viewport.prototype.setPosition=function(value,oldPosition){if(void 0===oldPosition&&(oldPosition=this.scrollPosition),oldPosition===value)return this.logger.log(function(){return["setting scroll position at",value,"[cancelled]"]}),value;this.routines.setScrollPosition(this.scrollable,value);var position=this.scrollPosition;return this.logger.log(function(){return["setting scroll position at",position]}),position},Object.defineProperty(Viewport.prototype,"scrollPosition",{get:function(){return this.routines.getScrollPosition(this.scrollable)},set:function(value){var oldPosition=this.scrollPosition,newPosition=this.setPosition(value,oldPosition),synthState=this.state.syntheticScroll;synthState.time=Number(Date.now()),synthState.position=newPosition,synthState.delta=newPosition-oldPosition,null===synthState.positionBefore&&(synthState.positionBefore=oldPosition)},enumerable:!0,configurable:!0}),Viewport.prototype.getSize=function(){return this.routines.getSize(this.host)},Viewport.prototype.getScrollableSize=function(){return this.routines.getSize(this.element)},Viewport.prototype.getBufferPadding=function(){return this.getSize()*this.settings.padding},Viewport.prototype.getEdge=function(direction,opposite){return this.routines.getEdge(this.host,direction,opposite)},Viewport.prototype.getElementEdge=function(element,direction,opposite){return this.routines.getEdge(element,direction,opposite)},Viewport.prototype.getOffset=function(){return this.routines.getOffset(this.element)},Viewport}(),ItemCache=function(item){this.$index=item.$index,this.nodeId=item.nodeId,this.data=item.data,this.size=item.size},RecalculateAverage=function(){function RecalculateAverage(){this.reset()}return RecalculateAverage.prototype.reset=function(){this.newItems=[],this.oldItems=[]},RecalculateAverage}(),Cache=function(){function Cache(itemSize,logger){this.averageSizeFloat=itemSize,this.averageSize=itemSize,this.itemSize=itemSize,this.items=new Map,this.recalculateAverage=new RecalculateAverage,this.reset(),this.logger=logger}return Cache.prototype.reset=function(){this.minIndex=1/0,this.maxIndex=-1/0,this.items.clear(),this.averageSizeFloat=this.itemSize,this.averageSize=this.itemSize,this.recalculateAverage.reset()},Cache.prototype.recalculateAverageSize=function(){var _this=this,_a=this.recalculateAverage,oldItemsLength=_a.oldItems.length,newItemsLength=_a.newItems.length;if(oldItemsLength||newItemsLength){var oldItemsSize=this.recalculateAverage.oldItems.reduce(function(acc,index){return acc+_this.getItemSize(index)},0),newItemsSize=this.recalculateAverage.newItems.reduce(function(acc,index){return acc+_this.getItemSize(index)},0);if(oldItemsLength){var averageSize=this.averageSizeFloat||0,averageSizeLength=this.items.size-newItemsLength-oldItemsLength;this.averageSizeFloat=(averageSizeLength*averageSize+oldItemsSize)/averageSizeLength}if(newItemsLength){averageSize=this.averageSizeFloat||0,averageSizeLength=this.items.size-newItemsLength;this.averageSizeFloat=(averageSizeLength*averageSize+newItemsSize)/this.items.size}this.averageSize=Math.round(this.averageSizeFloat),this.recalculateAverage.reset(),this.logger.log(function(){return"average size has been updated: "+_this.averageSize})}},Cache.prototype.add=function(item){var itemCache=this.get(item.$index);return itemCache?(itemCache.data=item.data,itemCache.size!==item.size&&(itemCache.size=item.size,this.recalculateAverage.oldItems.push(item.$index))):(itemCache=new ItemCache(item),this.items.set(item.$index,itemCache),this.averageSize!==itemCache.size&&this.recalculateAverage.newItems.push(item.$index)),item.$index<this.minIndex&&(this.minIndex=item.$index),item.$index>this.maxIndex&&(this.maxIndex=item.$index),itemCache},Cache.prototype.getItemSize=function(index){var item=this.get(index);return item?item.size:0},Cache.prototype.get=function(index){return this.items.get(index)},Cache}(),Buffer=function(){function Buffer(settings,startIndex,logger){this.$items=new rxjs.BehaviorSubject([]),this.cache=new Cache(settings.itemSize,logger),this.minIndexUser=settings.minIndex,this.maxIndexUser=settings.maxIndex,this.reset(),this.startIndex=startIndex,this.minBufferSize=settings.bufferSize,this.logger=logger}return Buffer.prototype.reset=function(reload,startIndex){reload&&this.items.forEach(function(item){return item.hide()}),this.items=[],this.pristine=!0,this.cache.reset(),this.absMinIndex=this.minIndexUser,this.absMaxIndex=this.maxIndexUser,void 0!==startIndex&&(this.startIndex=startIndex)},Object.defineProperty(Buffer.prototype,"items",{get:function(){return this._items},set:function(items){this.pristine=!1,this._items=items,this.$items.next(items)},enumerable:!0,configurable:!0}),Object.defineProperty(Buffer.prototype,"size",{get:function(){return this._items.length},enumerable:!0,configurable:!0}),Object.defineProperty(Buffer.prototype,"averageSize",{get:function(){return this.cache.averageSize},enumerable:!0,configurable:!0}),Object.defineProperty(Buffer.prototype,"hasItemSize",{get:function(){return void 0!==this.averageSize},enumerable:!0,configurable:!0}),Object.defineProperty(Buffer.prototype,"minIndex",{get:function(){return isFinite(this.cache.minIndex)?this.cache.minIndex:this.startIndex},enumerable:!0,configurable:!0}),Object.defineProperty(Buffer.prototype,"maxIndex",{get:function(){return isFinite(this.cache.maxIndex)?this.cache.maxIndex:this.startIndex},enumerable:!0,configurable:!0}),Object.defineProperty(Buffer.prototype,"bof",{get:function(){return this.items.length?this.items[0].$index===this.absMinIndex:isFinite(this.absMinIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(Buffer.prototype,"eof",{get:function(){return this.items.length?this.items[this.items.length-1].$index===this.absMaxIndex:isFinite(this.absMaxIndex)},enumerable:!0,configurable:!0}),Buffer.prototype.get=function($index){return this.items.find(function(item){return item.$index===$index})},Buffer.prototype.setItems=function(items){if(this.items.length)if(this.items[0].$index>items[items.length-1].$index)this.items=items.concat(this.items);else{if(!(items[0].$index>this.items[this.items.length-1].$index))return!1;this.items=this.items.concat(items)}else this.items=items;return!0},Buffer.prototype.getFirstVisibleItemIndex=function(){for(var length=this.items.length,i=0;i<length;i++)if(!this.items[i].invisible)return i;return-1},Buffer.prototype.getLastVisibleItemIndex=function(){for(var i=this.items.length-1;0<=i;i--)if(!this.items[i].invisible)return i;return-1},Buffer.prototype.getFirstVisibleItem=function(){var index=this.getFirstVisibleItemIndex();if(0<=index)return this.items[index]},Buffer.prototype.getLastVisibleItem=function(){var index=this.getLastVisibleItemIndex();if(0<=index)return this.items[index]},Buffer.prototype.getEdgeVisibleItem=function(direction,opposite){return direction===(opposite?Direction_backward:Direction_forward)?this.getLastVisibleItem():this.getFirstVisibleItem()},Buffer.prototype.getVisibleItemsCount=function(){return this.items.reduce(function(acc,item){return acc+(item.invisible?0:1)},0)},Buffer.prototype.getSizeByIndex=function(index){var item=this.cache.get(index);return item?item.size:this.averageSize},Buffer.prototype.checkAverageSize=function(){this.cache.recalculateAverageSize()},Buffer}(),FetchModel=function(){function FetchModel(){this.callCount=0,this.reset()}return FetchModel.prototype.reset=function(){this._newItemsData=null,this.items=[],this.firstIndexBuffer=null,this.lastIndexBuffer=null,this.firstIndex=null,this.lastIndex=null,this.hasAnotherPack=!1,this.negativeSize=0,this.direction=null,this.isPrepend=!1},Object.defineProperty(FetchModel.prototype,"newItemsData",{get:function(){return this._newItemsData},set:function(items){this._newItemsData=items,this.callCount++},enumerable:!0,configurable:!0}),Object.defineProperty(FetchModel.prototype,"shouldFetch",{get:function(){return!!this.count},enumerable:!0,configurable:!0}),Object.defineProperty(FetchModel.prototype,"hasNewItems",{get:function(){return!(!this._newItemsData||!this._newItemsData.length)},enumerable:!0,configurable:!0}),Object.defineProperty(FetchModel.prototype,"index",{get:function(){return this.firstIndex},enumerable:!0,configurable:!0}),Object.defineProperty(FetchModel.prototype,"count",{get:function(){return null!==this.firstIndex&&null!==this.lastIndex?this.lastIndex-this.firstIndex+1:0},enumerable:!0,configurable:!0}),FetchModel}(),WindowScrollState=function(){function WindowScrollState(){this.reset()}return WindowScrollState.prototype.reset=function(){this.delta=0,this.positionToUpdate=0},WindowScrollState}(),ScrollState=function(){function ScrollState(){this.window=new WindowScrollState,this.reset()}return ScrollState.prototype.reset=function(){this.firstScroll=!1,this.firstScrollTime=0,this.lastScrollTime=0,this.scrollTimer=null,this.workflowTimer=null,this.scroll=!1,this.keepScroll=!1,this.window.reset()},ScrollState}(),SyntheticScroll=function(){function SyntheticScroll(){this.reset(null)}return SyntheticScroll.prototype.reset=function(position){void 0===position&&(position=null),this.position=position,this.positionBefore=null,this.delta=0,this.time=0,this.readyToReset=!1},SyntheticScroll}(),State=function(){function State(settings,logger){this.settings=settings,this.logger=logger,this.initTime=Number(new Date),this.innerLoopCount=0,this.isInitialLoop=!1,this.workflowCycleCount=1,this.isInitialWorkflowCycle=!1,this.countDone=0,this.setCurrentStartIndex(settings.startIndex),this.fetch=new FetchModel,this.clip=!1,this.clipCall=0,this.sizeBeforeRender=0,this.fwdPaddingBeforeRender=0,this.bwdPaddingAverageSizeItemsCount=0,this.scrollState=new ScrollState,this.syntheticScroll=new SyntheticScroll,this.loopPendingSource=new rxjs.BehaviorSubject(!1),this.workflowPendingSource=new rxjs.BehaviorSubject(!1),this.isLoadingSource=new rxjs.BehaviorSubject(!1),this.firstVisibleSource=new rxjs.BehaviorSubject(itemAdapterEmpty),this.lastVisibleSource=new rxjs.BehaviorSubject(itemAdapterEmpty),this.firstVisibleWanted=!1,this.lastVisibleWanted=!1}return Object.defineProperty(State.prototype,"loopPending",{get:function(){return this.loopPendingSource.getValue()},set:function(value){this.loopPending!==value&&this.loopPendingSource.next(value)},enumerable:!0,configurable:!0}),Object.defineProperty(State.prototype,"workflowPending",{get:function(){return this.workflowPendingSource.getValue()},set:function(value){this.workflowPending!==value&&this.workflowPendingSource.next(value)},enumerable:!0,configurable:!0}),Object.defineProperty(State.prototype,"isLoading",{get:function(){return this.isLoadingSource.getValue()},set:function(value){this.isLoading!==value&&this.isLoadingSource.next(value)},enumerable:!0,configurable:!0}),Object.defineProperty(State.prototype,"firstVisibleItem",{get:function(){return this.firstVisibleSource.getValue()},set:function(item){this.firstVisibleItem.$index!==item.$index&&this.firstVisibleSource.next(item)},enumerable:!0,configurable:!0}),Object.defineProperty(State.prototype,"lastVisibleItem",{get:function(){return this.lastVisibleSource.getValue()},set:function(item){this.lastVisibleItem.$index!==item.$index&&this.lastVisibleSource.next(item)},enumerable:!0,configurable:!0}),Object.defineProperty(State.prototype,"time",{get:function(){return Number(new Date)-this.initTime},enumerable:!0,configurable:!0}),State.prototype.startLoop=function(options){this.loopPending=!0,this.innerLoopCount++,this.fetch.reset(),this.clip=!1,options&&(this.scrollState.scroll=options.scroll||!1),this.scrollState.keepScroll=!1},State.prototype.endLoop=function(){this.loopPending=!1,this.countDone++,this.isInitialLoop=!1},State.prototype.setCurrentStartIndex=function(newStartIndex){var _a=this.settings,startIndex=_a.startIndex,minIndex=_a.minIndex,maxIndex=_a.maxIndex,index=Number(newStartIndex);isNaN(index)&&(this.logger.log(function(){return"fallback startIndex to settings.startIndex ("+startIndex+") because "+newStartIndex+" is not a number"}),index=startIndex),index<minIndex&&(this.logger.log(function(){return"setting startIndex to settings.minIndex ("+minIndex+") because "+index+" < "+minIndex}),index=minIndex),maxIndex<index&&(this.logger.log(function(){return"setting startIndex to settings.maxIndex ("+maxIndex+") because "+index+" > "+maxIndex}),index=maxIndex),this.startIndex=index},State}(),instanceCount=0,Scroller=function(){function Scroller(context,callWorkflow){var datasource=function(datasource){if(!datasource)throw new Error("No datasource provided");if(!("get"in datasource))throw new Error("Datasource get method is not implemented");if("function"!=typeof datasource.get)throw new Error("Datasource get is not a function");if(datasource.get.length<2)throw new Error("Datasource get method invalid signature");return datasource}(context.datasource);this.datasource=datasource,this.version=context.version,this.runChangeDetector=function(){return context.changeDetector.markForCheck()},this.callWorkflow=callWorkflow,this.innerLoopSubscriptions=[],this.settings=new Settings(datasource.settings,datasource.devSettings,++instanceCount),this.logger=new Logger(this),this.routines=new Routines(this.settings),this.state=new State(this.settings,this.logger),this.buffer=new Buffer(this.settings,this.state.startIndex,this.logger),this.viewport=new Viewport(context.elementRef,this.settings,this.routines,this.state,this.logger),this.logger.object("uiScroll settings object",this.settings,!0),datasource.constructed?this.datasource.adapter.initialize(this):(this.datasource=new Datasource(datasource,!this.settings.adapter),this.settings.adapter&&this.datasource.adapter.initialize(this))}return Scroller.prototype.init=function(){this.viewport.reset(0)},Scroller.prototype.bindData=function(){return this.runChangeDetector(),rxjs.Observable.create(function(observer){setTimeout(function(){observer.next(!0),observer.complete()})})},Scroller.prototype.purgeInnerLoopSubscriptions=function(){this.innerLoopSubscriptions.forEach(function(item){return item.unsubscribe()}),this.innerLoopSubscriptions=[]},Scroller.prototype.purgeScrollTimers=function(localOnly){var scrollState=this.state.scrollState;scrollState.scrollTimer&&(clearTimeout(scrollState.scrollTimer),scrollState.scrollTimer=null),!localOnly&&scrollState.workflowTimer&&(clearTimeout(scrollState.workflowTimer),scrollState.workflowTimer=null)},Scroller.prototype.dispose=function(){this.purgeInnerLoopSubscriptions(),this.purgeScrollTimers()},Scroller.prototype.finalize=function(){},Scroller}(),Init=function(){function Init(){}return Init.run=function(scroller,payload){scroller.state.isInitialWorkflowCycle=!payload,scroller.state.isInitialLoop=!payload,scroller.state.workflowPending=!0,scroller.state.isLoading=!0,scroller.callWorkflow({process:Process_init,status:ProcessStatus_next,payload:{scroll:payload&&payload.scroll||!1}})},Init}(),Scroll=function(){function Scroll(){}return Scroll.run=function(scroller,payload){void 0===payload&&(payload={}),scroller.logger.log(scroller.viewport.scrollPosition),(null===scroller.state.syntheticScroll.position||Scroll.processSyntheticScroll(scroller))&&this.delayScroll(scroller,payload)},Scroll.processSyntheticScroll=function(scroller){var viewport=scroller.viewport,syntheticScroll=scroller.state.syntheticScroll,settings=scroller.settings,logger=scroller.logger,time=Number(new Date),synthetic=__assign({},syntheticScroll),position=viewport.scrollPosition,synthScrollDelay=time-synthetic.time;if(synthScrollDelay>settings.maxSynthScrollDelay)return logger.log(function(){return"reset synthetic scroll params ("+synthScrollDelay+" > "+settings.maxSynthScrollDelay+")"}),syntheticScroll.reset(),position!==synthetic.position;if(syntheticScroll.readyToReset=!0,position===synthetic.position)return logger.log(function(){return"skip synthetic scroll ("+position+")"}),!1;if(synthetic.readyToReset&&(syntheticScroll.position=null,syntheticScroll.positionBefore=null,logger.log(function(){return"reset synthetic scroll params"})),settings.windowViewport)return synthetic.readyToReset||(logger.log(function(){return"reset synthetic scroll params (window)"}),syntheticScroll.reset()),!0;if(position!==synthetic.position){var inertiaDelta_1=synthetic.positionBefore-position,syntheticDelta_1=synthetic.position-position;if(0<inertiaDelta_1&&inertiaDelta_1<syntheticDelta_1){var newPosition_1=Math.max(0,position+syntheticScroll.delta);logger.log(function(){return"inertia scroll adjustment. Position: "+position+", synthetic position: "+synthetic.position+", synthetic position before: "+synthetic.positionBefore+", synthetic delay: "+synthScrollDelay+", synthetic delta: "+syntheticDelta_1+", inertia delta: "+inertiaDelta_1+", new position: "+newPosition_1}),settings.inertia?inertiaDelta_1<=settings.inertiaScrollDelta&&synthScrollDelay<=settings.inertiaScrollDelay&&(viewport.scrollPosition=newPosition_1):viewport.scrollPosition=newPosition_1}}return!0},Scroll.delayScroll=function(scroller,payload){if(scroller.settings.throttle&&!payload.byTimer){var scrollState=scroller.state.scrollState,time=Number(Date.now()),tDiff=scrollState.lastScrollTime+scroller.settings.throttle-time,dDiff=scroller.settings.throttle+(scrollState.firstScrollTime?scrollState.firstScrollTime-time:0),diff=Math.max(tDiff,dDiff);diff<=0?(scroller.purgeScrollTimers(!0),scrollState.lastScrollTime=time,scrollState.firstScrollTime=0,Scroll.doScroll(scroller)):scrollState.scrollTimer||scrollState.keepScroll||(scroller.logger.log(function(){return"setting the timer at "+(scroller.state.time+diff)}),scrollState.firstScrollTime=time,scrollState.scrollTimer=setTimeout(function(){scrollState.scrollTimer=null,scroller.logger.log(function(){return"fire the timer ("+scroller.state.time+")"}),Scroll.run(scroller,{byTimer:!0})},diff))}else Scroll.doScroll(scroller)},Scroll.doScroll=function(scroller){var state=scroller.state,scrollState=scroller.state.scrollState;if(state.workflowPending)return scroller.logger.log(function(){return scrollState.keepScroll?void 0:["setting %ckeepScroll%c flag (scrolling while the Workflow is pending)","color: #006600;","color: #000000;"]}),void(scrollState.keepScroll=!0);scroller.callWorkflow({process:Process_scroll,status:ProcessStatus_next,payload:__assign({scroll:!0},scrollState.keepScroll?{keepScroll:scrollState.keepScroll}:{})})},Scroll}(),Reload=function(){function Reload(){}return Reload.run=function(scroller,reloadIndex){var scrollPosition=scroller.viewport.scrollPosition;scroller.state.setCurrentStartIndex(reloadIndex),scroller.buffer.reset(!0,scroller.state.startIndex),scroller.viewport.reset(scrollPosition),scroller.purgeInnerLoopSubscriptions(),scroller.purgeScrollTimers(),scroller.callWorkflow({process:Process_reload,status:ProcessStatus_next})},Reload}(),Start=function(){function Start(){}return Start.run=function(scroller,payload){scroller.state.startLoop(payload),scroller.callWorkflow({process:Process_start,status:ProcessStatus_next})},Start}(),PreFetch=function(){function PreFetch(){}return PreFetch.run=function(scroller){var fetch=scroller.state.fetch;scroller.state.preFetchPosition=scroller.viewport.scrollPosition,fetch.minIndex=scroller.buffer.minIndex,fetch.averageItemSize=scroller.buffer.averageSize||0,PreFetch.setStartDelta(scroller),PreFetch.setFetchIndexes(scroller),PreFetch.skipBufferedItems(scroller),PreFetch.checkFetchPackSize(scroller),PreFetch.setFetchDirection(scroller),fetch.shouldFetch&&scroller.logger.log(function(){return"going to fetch "+fetch.count+" items started from index "+fetch.index}),scroller.callWorkflow({process:Process_preFetch,status:scroller.state.fetch.shouldFetch?ProcessStatus_next:ProcessStatus_done})},PreFetch.setStartDelta=function(scroller){var buffer=scroller.buffer,viewport=scroller.viewport;if(viewport.startDelta=0,buffer.hasItemSize){for(var index=isFinite(buffer.absMinIndex)?buffer.absMinIndex:buffer.minIndex;index<scroller.state.startIndex;index++){var item=buffer.cache.get(index);viewport.startDelta+=item?item.size:buffer.averageSize}scroller.settings.windowViewport&&(viewport.startDelta+=viewport.getOffset()),scroller.logger.log(function(){return"start delta is "+viewport.startDelta})}},PreFetch.setFetchIndexes=function(scroller){var state=scroller.state,viewport=scroller.viewport,paddingDelta=viewport.getBufferPadding(),relativePosition=state.preFetchPosition-viewport.startDelta,startPosition=relativePosition-paddingDelta,endPosition=relativePosition+viewport.getSize()+paddingDelta,firstIndexPosition=PreFetch.setFirstIndexBuffer(scroller,startPosition);PreFetch.setLastIndexBuffer(scroller,firstIndexPosition,endPosition),scroller.logger.fetch()},PreFetch.setFirstIndexBuffer=function(scroller,startPosition){var state=scroller.state,buffer=scroller.buffer,fetch=scroller.state.fetch,firstIndex=state.startIndex,firstIndexPosition=0;if(scroller.state.isInitialLoop)scroller.logger.log("skipping fetch backward direction [initial loop]");else for(var inc=startPosition<0?-1:1,position=firstIndexPosition,index=firstIndex;!((index+=inc)<buffer.absMinIndex);)if(position+=inc*buffer.getSizeByIndex(index),inc<0){if(firstIndex=index,(firstIndexPosition=position)<=startPosition)break}else{if(startPosition<position)break;firstIndex=index,firstIndexPosition=position}return fetch.firstIndex=fetch.firstIndexBuffer=Math.max(firstIndex,buffer.absMinIndex),firstIndexPosition},PreFetch.setLastIndexBuffer=function(scroller,startPosition,endPosition){var lastIndex,state=scroller.state,buffer=scroller.buffer,settings=scroller.settings;if(buffer.hasItemSize){var index=state.fetch.firstIndexBuffer,position=startPosition;for(lastIndex=index;!(lastIndex=index,index++,endPosition<=(position+=buffer.getSizeByIndex(index))||index>buffer.absMaxIndex););}else lastIndex=state.startIndex+settings.bufferSize-1,scroller.logger.log("forcing fetch forward direction [no item size]");state.fetch.lastIndex=state.fetch.lastIndexBuffer=Math.min(lastIndex,buffer.absMaxIndex)},PreFetch.skipBufferedItems=function(scroller){var buffer=scroller.buffer;if(buffer.size){for(var fetch=scroller.state.fetch,firstIndex=fetch.firstIndex,lastIndex=fetch.lastIndex,packs=[[]],p=0,i=firstIndex;i<=lastIndex;i++)buffer.get(i)?packs[p].length&&(packs[++p]=[]):packs[p].push(i);var pack=packs[0];packs[0].length&&packs[1]&&packs[1].length&&(fetch.hasAnotherPack=!0,packs[1].length>=packs[0].length&&(pack=packs[1])),fetch.firstIndex=Math.max(pack[0],buffer.absMinIndex),fetch.lastIndex=Math.min(pack[pack.length-1],buffer.absMaxIndex),fetch.firstIndex===firstIndex&&fetch.lastIndex===lastIndex||scroller.logger.fetch("after Buffer flushing")}},PreFetch.checkFetchPackSize=function(scroller){var buffer=scroller.buffer,fetch=scroller.state.fetch;if(fetch.shouldFetch){var firstIndex=fetch.firstIndex,lastIndex=fetch.lastIndex,diff=scroller.settings.bufferSize-(lastIndex-firstIndex+1);if(!(diff<=0)){if(!buffer.size||lastIndex>buffer.items[0].$index){var newLastIndex=Math.min(lastIndex+diff,buffer.absMaxIndex);lastIndex<newLastIndex&&(fetch.lastIndex=fetch.lastIndexBuffer=newLastIndex)}else{var newFirstIndex=Math.max(firstIndex-diff,buffer.absMinIndex);newFirstIndex<firstIndex&&(fetch.firstIndex=fetch.firstIndexBuffer=newFirstIndex)}fetch.firstIndex===firstIndex&&fetch.lastIndex===lastIndex||(scroller.logger.fetch("after bufferSize adjustment"),PreFetch.skipBufferedItems(scroller))}}},PreFetch.setFetchDirection=function(scroller){var buffer=scroller.buffer,fetch=scroller.state.fetch;if(fetch.lastIndex){var direction_1=Direction_forward;buffer.size&&(direction_1=fetch.lastIndex<buffer.items[0].$index?Direction_backward:Direction_forward),fetch.direction=direction_1,scroller.logger.log(function(){return'fetch direction is "'+direction_1+'"'})}},PreFetch}(),Fetch=function(){function Fetch(){}return Fetch.run=function(scroller){var result=Fetch.get(scroller);"function"!=typeof result.subscribe?result.isError?Fetch.fail(result.error,scroller):Fetch.success(result.data,scroller):scroller.innerLoopSubscriptions.push(result.subscribe(function(data){return Fetch.success(data,scroller)},function(error){return Fetch.fail(error,scroller)}))},Fetch.success=function(data,scroller){scroller.logger.log(function(){return"resolved "+data.length+" items (index = "+scroller.state.fetch.index+", count = "+scroller.state.fetch.count+")"}),scroller.state.fetch.newItemsData=data,scroller.callWorkflow({process:Process_fetch,status:ProcessStatus_next})},Fetch.fail=function(error,scroller){scroller.callWorkflow({process:Process_fetch,status:ProcessStatus_error,payload:{error:error}})},Fetch.get=function(scroller){var immediateData,immediateError,observer,success=function(data){observer?(observer.next(data),observer.complete()):immediateData=data||null},reject=function(error){observer?observer.error(error):immediateError=error||null},result=(0,scroller.datasource.get)(scroller.state.fetch.index,scroller.state.fetch.count,success,reject);if(result&&"function"==typeof result.then)result.then(success,reject);else if(result&&"function"==typeof result.subscribe)return result;return void 0!==immediateData||void 0!==immediateError?{data:immediateData,error:immediateError,isError:void 0!==immediateError}:rxjs.Observable.create(function(_observer){observer=_observer})},Fetch}(),Item=function(){function Item($index,data,routines){this.$index=$index,this.data=data,this.nodeId=String($index),this.routines=routines,this.invisible=!0}return Item.prototype.setSize=function(){this.size=this.routines.getSize(this.element)},Item.prototype.hide=function(){this.element&&this.routines.hideElement(this.element)},Item}(),PostFetch=function(){function PostFetch(){}return PostFetch.run=function(scroller){PostFetch.setItems(scroller)?(PostFetch.setBufferLimits(scroller),scroller.callWorkflow({process:Process_postFetch,status:scroller.state.fetch.hasNewItems?ProcessStatus_next:ProcessStatus_done})):scroller.callWorkflow({process:Process_postFetch,status:ProcessStatus_error,payload:{error:"Can't set buffer items"}})},PostFetch.setBufferLimits=function(scroller){var buffer=scroller.buffer,_a=scroller.state.fetch,firstIndex=_a.firstIndex,lastIndex=_a.lastIndex,items=_a.items;if(items.length){var last=items.length-1;firstIndex<items[0].$index&&(buffer.absMinIndex=items[0].$index),lastIndex>items[last].$index&&(buffer.absMaxIndex=items[last].$index)}else lastIndex<buffer.minIndex&&(buffer.absMinIndex=buffer.minIndex),firstIndex>buffer.maxIndex&&(buffer.absMaxIndex=buffer.maxIndex)},PostFetch.setItems=function(scroller){var buffer=scroller.buffer,fetch=scroller.state.fetch,items=fetch.newItemsData;if(!items||!items.length)return!0;var fetchIndex=fetch.index;return items.length<fetch.count&&(scroller.state.isInitialLoop?fetchIndex=scroller.state.startIndex:fetch.firstIndex<buffer.minIndex&&(fetchIndex=buffer.minIndex-items.length)),fetch.items=items.map(function(item,index){return new Item(fetchIndex+index,item,scroller.routines)}),fetch.isPrepend=!!buffer.items.length&&buffer.items[0].$index>fetch.items[fetch.items.length-1].$index,buffer.setItems(fetch.items)},PostFetch}(),Render=function(){function Render(){}return Render.run=function(scroller){scroller.logger.stat("before new items render"),scroller.innerLoopSubscriptions.push(scroller.bindData().subscribe(function(){Render.processElements(scroller)?scroller.callWorkflow({process:Process_render,status:ProcessStatus_next}):scroller.callWorkflow({process:Process_render,status:ProcessStatus_error,payload:{error:"Can't associate item with element"}})}))},Render.processElements=function(scroller){var state=scroller.state,_a=scroller.state,fetch=_a.fetch,items=_a.fetch.items,viewport=scroller.viewport,buffer=scroller.buffer,itemsLength=items.length,scrollBeforeRender=scroller.settings.windowViewport?scroller.viewport.scrollPosition:0;state.sizeBeforeRender=viewport.getScrollableSize(),state.fwdPaddingBeforeRender=viewport.paddings.forward.size;for(var j=0;j<itemsLength;j++){var item=items[j],element=viewport.element.querySelector('[data-sid="'+item.nodeId+'"]');if(!element)return!1;item.element=element,item.element.style.left="",item.element.style.position="",item.invisible=!1,item.setSize(),buffer.cache.add(item),item.$index<fetch.minIndex&&(fetch.negativeSize+=item.size)}return buffer.checkAverageSize(),scroller.settings.windowViewport&&fetch.isPrepend&&Render.processWindowScrollBackJump(scroller,scrollBeforeRender),scroller.logger.stat("after new items render"),!0},Render.processWindowScrollBackJump=function(scroller,scrollBeforeRender){var state=scroller.state,window=scroller.state.scrollState.window,viewport=scroller.viewport,delta=(scrollBeforeRender>=viewport.paddings.backward.size?1:-1)*Math.abs(viewport.getScrollableSize()-state.sizeBeforeRender),positionToUpdate=scrollBeforeRender-delta;delta&&0<positionToUpdate&&(window.positionToUpdate=positionToUpdate,window.delta=delta,scroller.logger.log(function(){return["next scroll position (if "+positionToUpdate+") should be "+(delta<0?"reduced":"increased")+" by",Math.abs(delta)]}))},Render}(),Adjust=function(){function Adjust(){}return Adjust.run=function(scroller){scroller.state.preAdjustPosition=scroller.viewport.scrollPosition;var setPaddingsResult=Adjust.setPaddings(scroller);!1!==setPaddingsResult?(Adjust.fixScrollPosition(scroller,setPaddingsResult),scroller.callWorkflow({process:Process_adjust,status:ProcessStatus_done})):scroller.callWorkflow({process:Process_adjust,status:ProcessStatus_error,payload:{error:"Can't get visible item"}})},Adjust.setPaddings=function(scroller){var viewport=scroller.viewport,buffer=scroller.buffer,fetch=scroller.state.fetch,firstItem=buffer.getFirstVisibleItem(),lastItem=buffer.getLastVisibleItem();if(!firstItem||!lastItem)return!1;var index,forwardPadding=viewport.paddings.forward,backwardPadding=viewport.paddings.backward,firstIndex=firstItem.$index,lastIndex=lastItem.$index,minIndex=isFinite(buffer.absMinIndex)?buffer.absMinIndex:buffer.minIndex,maxIndex=isFinite(buffer.absMaxIndex)?buffer.absMaxIndex:buffer.maxIndex,hasAverageItemSizeChanged=buffer.averageSize!==fetch.averageItemSize,bwdSize=0,fwdSize=0,bwdPaddingAverageSizeItemsCount=0;for(index=minIndex;index<firstIndex;index++){bwdSize+=(item=buffer.cache.get(index))?item.size:buffer.cache.averageSize,hasAverageItemSizeChanged&&(bwdPaddingAverageSizeItemsCount+=item?0:1)}if(hasAverageItemSizeChanged)for(index=firstIndex;index<fetch.firstIndexBuffer;index++)bwdPaddingAverageSizeItemsCount+=buffer.cache.get(index)?0:1;for(index=lastIndex+1;index<=maxIndex;index++){var item;fwdSize+=(item=buffer.cache.get(index))?item.size:buffer.cache.averageSize}var fwdPaddingDiff=forwardPadding.size-fwdSize,viewportSizeDiff=viewport.getSize()-viewport.getScrollableSize()+fwdPaddingDiff;return 0<viewportSizeDiff&&(fwdSize+=viewportSizeDiff,scroller.logger.log("forward padding will be increased by "+viewportSizeDiff+" to fill the viewport")),forwardPadding.size=fwdSize,backwardPadding.size=bwdSize,scroller.logger.stat("after paddings adjustments"),bwdPaddingAverageSizeItemsCount},Adjust.fixScrollPosition=function(scroller,bwdPaddingAverageSizeItemsCount){var viewport=scroller.viewport,buffer=scroller.buffer,state=scroller.state,_a=scroller.state,fetch=_a.fetch,_b=_a.fetch,items=_b.items,negativeSize=_b.negativeSize;if(scroller.settings.windowViewport){var newPosition_1=viewport.scrollPosition,posDiff_1=state.preAdjustPosition-newPosition_1;if(posDiff_1){var winState=state.scrollState.window;if(newPosition_1===winState.positionToUpdate)return winState.reset(),state.syntheticScroll.readyToReset=!1,scroller.logger.log(function(){return"process window scroll preventive: sum("+newPosition_1+", "+posDiff_1+")"}),Adjust.setScroll(scroller,posDiff_1),void scroller.logger.stat("after scroll position adjustment (window)")}}var hasAverageItemSizeChanged=buffer.averageSize!==fetch.averageItemSize,bwdAverageItemsCountDiff=state.bwdPaddingAverageSizeItemsCount-bwdPaddingAverageSizeItemsCount;if(hasAverageItemSizeChanged&&(0<bwdPaddingAverageSizeItemsCount||0<bwdAverageItemsCountDiff)){var positionDiff=bwdPaddingAverageSizeItemsCount*buffer.averageSize-bwdPaddingAverageSizeItemsCount*fetch.averageItemSize-bwdAverageItemsCountDiff*fetch.averageItemSize;positionDiff&&(Adjust.setScroll(scroller,positionDiff),scroller.logger.stat("after scroll position adjustment (average)")),state.bwdPaddingAverageSizeItemsCount=bwdPaddingAverageSizeItemsCount}state.sizeBeforeRender===viewport.getScrollableSize()&&viewport.paddings.forward.size===state.fwdPaddingBeforeRender||items[0].$index>=fetch.minIndex||(0<negativeSize?Adjust.setScroll(scroller,negativeSize):negativeSize<0&&(viewport.paddings.forward.size-=negativeSize,viewport.scrollPosition-=negativeSize),scroller.logger.stat("after scroll position adjustment (negative)"))},Adjust.setScroll=function(scroller,delta){for(var viewport=scroller.viewport,forwardPadding=viewport.paddings[Direction_forward],oldPosition=viewport.scrollPosition,newPosition=Math.round(oldPosition+delta),i=0;i<Adjust.MAX_SCROLL_ADJUSTMENTS_COUNT;i++){var positionDiff=(viewport.scrollPosition=newPosition)-viewport.scrollPosition;if(!(0<positionDiff))break;forwardPadding.size+=positionDiff}},Adjust.MAX_SCROLL_ADJUSTMENTS_COUNT=10,Adjust}(),Clip=function(){function Clip(){}return Clip.run=function(scroller){Clip.prepareClip(scroller),scroller.state.clip&&Clip.doClip(scroller),scroller.callWorkflow({process:Process_clip,status:ProcessStatus_next})},Clip.prepareClip=function(scroller){var buffer=scroller.buffer,state=scroller.state,_a=scroller.state,fetch=_a.fetch,direction=_a.fetch.direction;if(buffer.size)if(!state.isInitialWorkflowCycle||state.scrollState.scroll){var firstIndex=fetch.firstIndexBuffer,lastIndex=fetch.lastIndexBuffer;scroller.logger.log(function(){return"looking for "+(direction?"anti-"+direction+" ":"")+"items that are out of ["+firstIndex+".."+lastIndex+"] range"}),direction&&direction!==Direction_forward||firstIndex-1>=buffer.absMinIndex&&Clip.prepareClipByDirection(scroller,Direction_forward,firstIndex),direction&&direction!==Direction_backward||lastIndex+1<=buffer.absMaxIndex&&Clip.prepareClipByDirection(scroller,Direction_backward,lastIndex)}else scroller.logger.log("skipping clip [initial cycle, no scroll]")},Clip.prepareClipByDirection=function(scroller,direction,edgeIndex){var forward=direction===Direction_forward;scroller.buffer.items.forEach(function(item){(forward&&item.$index<edgeIndex||!forward&&item.$index>edgeIndex)&&(item.toRemove=!0,item.removeDirection=direction,scroller.state.clip=!0)})},Clip.doClip=function(scroller){var buffer=scroller.buffer,paddings=scroller.viewport.paddings,logger=scroller.logger,clipped=[],size={backward:0,forward:0};scroller.state.clipCall++,logger.stat("before clip ("+scroller.state.clipCall+")"),buffer.items=buffer.items.filter(function(item){return!item.toRemove||(size[item.removeDirection]+=item.size,item.hide(),clipped.push(item.$index),!1)}),size.backward&&(paddings.forward.size+=size.backward),size.forward&&(paddings.backward.size+=size.forward),logger.log(function(){return["clipped "+clipped.length+" items"+(size.backward?", +"+size.backward+" fwd px,":"")+(size.forward?", +"+size.forward+" bwd px,":""),"range: ["+clipped[0]+".."+clipped[clipped.length-1]+"]"]}),logger.stat("after clip")},Clip}(),End=function(){function End(){}return End.run=function(scroller,error){End.endWorkflowLoop(scroller),End.calculateParams(scroller);var next=End.getNext(scroller,error);scroller.state.clip&&scroller.runChangeDetector(),scroller.finalize(),scroller.callWorkflow({process:Process_end,status:next?ProcessStatus_next:ProcessStatus_done,payload:next||{empty:!0}}),scroller.state.workflowPending&&!scroller.state.loopPending&&End.continueWorkflowByTimer(scroller)},End.endWorkflowLoop=function(scroller){var state=scroller.state;state.endLoop(),state.lastPosition=scroller.viewport.scrollPosition,scroller.purgeInnerLoopSubscriptions()},End.calculateParams=function(scroller){var items=scroller.buffer.items;if(scroller.state.firstVisibleWanted){var viewportBackwardEdge_1=scroller.viewport.getEdge(Direction_backward),firstItem=items.find(function(item){return scroller.viewport.getElementEdge(item.element,Direction_forward)>viewportBackwardEdge_1});scroller.state.firstVisibleItem=firstItem?{$index:firstItem.$index,data:firstItem.data,element:firstItem.element}:itemAdapterEmpty}if(scroller.state.lastVisibleWanted){for(var viewportForwardEdge=scroller.viewport.getEdge(Direction_forward),lastItem=null,i=items.length-1;0<=i;i--){if(scroller.viewport.getElementEdge(items[i].element,Direction_backward)<viewportForwardEdge){lastItem=items[i];break}}scroller.state.lastVisibleItem=lastItem?{$index:lastItem.$index,data:lastItem.data,element:lastItem.element}:itemAdapterEmpty}},End.getNext=function(scroller,error){var _a=scroller.state,fetch=_a.fetch,scrollState=_a.scrollState,next=null;return error||(fetch.hasNewItems?next={scroll:!1}:fetch.hasAnotherPack&&(next={scroll:!1}),scrollState.keepScroll&&(next={scroll:!0,keepScroll:!0})),next},End.continueWorkflowByTimer=function(scroller){var state=scroller.state,_a=scroller.state,workflowCycleCount=_a.workflowCycleCount,innerLoopCount=_a.innerLoopCount;scroller.logger.log(function(){return"setting Workflow timer ("+workflowCycleCount+"-"+innerLoopCount+")"}),state.scrollState.workflowTimer=setTimeout(function(){state.workflowPending&&!state.loopPending&&innerLoopCount===state.innerLoopCount&&scroller.callWorkflow({process:Process_end,status:ProcessStatus_next,payload:{scroll:!0,byTimer:!0}})},scroller.settings.throttle)},End}(),Workflow=function(){function Workflow(context){var _this=this;this.context=context,this.scroller=new Scroller(this.context,this.callWorkflow.bind(this)),this.process$=new rxjs.BehaviorSubject({process:Process_init,status:ProcessStatus_start}),this.cyclesDone=0,this.onScrollHandler=function(event){return Scroll.run(_this.scroller,{event:event})},this.scroller.settings.initializeDelay?setTimeout(function(){return _this.init()},this.scroller.settings.initializeDelay):this.init()}return Workflow.prototype.init=function(){this.scroller.init(),this.scroller.logger.stat("initialization"),this.initListeners()},Workflow.prototype.initListeners=function(){var _this=this,scroller=this.scroller;scroller.logger.log(function(){return"uiScroll Workflow listeners are being initialized"}),this.itemsSubscription=scroller.buffer.$items.subscribe(function(items){return _this.context.items=items}),this.workflowSubscription=this.process$.subscribe(this.process.bind(this)),this.initScrollEventListener()},Workflow.prototype.initScrollEventListener=function(){var passiveSupported=!1;try{window.addEventListener("test",{},Object.defineProperty({},"passive",{get:function(){return passiveSupported=!0}}))}catch(err){}this.scrollEventOptions=!!passiveSupported&&{passive:!1},this.scroller.viewport.scrollEventElement.addEventListener("scroll",this.onScrollHandler,this.scrollEventOptions)},Workflow.prototype.detachScrollEventListener=function(){this.scroller.viewport.scrollEventElement.removeEventListener("scroll",this.onScrollHandler,this.scrollEventOptions)},Workflow.prototype.process=function(data){var scroller=this.scroller,status=data.status,payload=data.payload;if(this.scroller.logger.logProcess(data),status!==ProcessStatus_error)switch(data.process){case Process_init:status===ProcessStatus_start&&Init.run(scroller),status===ProcessStatus_next&&Start.run(scroller,payload);break;case Process_reload:status===ProcessStatus_start&&Reload.run(scroller,payload),status===ProcessStatus_next&&Init.run(scroller);break;case Process_scroll:status===ProcessStatus_next&&(payload&&payload.keepScroll?Start.run(scroller,payload):Init.run(scroller,payload));break;case Process_start:status===ProcessStatus_next&&PreFetch.run(scroller);break;case Process_preFetch:status===ProcessStatus_done&&End.run(scroller),status===ProcessStatus_next&&Fetch.run(scroller);break;case Process_fetch:status===ProcessStatus_next&&PostFetch.run(scroller);break;case Process_postFetch:status===ProcessStatus_next&&Render.run(scroller),status===ProcessStatus_done&&End.run(scroller);break;case Process_render:status===ProcessStatus_next&&(scroller.settings.infinite?Adjust.run(scroller):Clip.run(scroller));break;case Process_clip:status===ProcessStatus_next&&Adjust.run(scroller);break;case Process_adjust:status===ProcessStatus_done&&End.run(scroller);break;case Process_end:status===ProcessStatus_next&&(payload&&payload.keepScroll?Scroll.run(scroller):Start.run(scroller,payload)),status===ProcessStatus_done&&this.done()}else End.run(scroller,payload)},Workflow.prototype.callWorkflow=function(processSubject){this.process$.next(processSubject)},Workflow.prototype.done=function(){var state=this.scroller.state;this.cyclesDone++,state.workflowCycleCount=this.cyclesDone+1,state.isInitialWorkflowCycle=!1,state.workflowPending=!1,null===state.scrollState.scrollTimer&&(state.isLoading=!1),this.finalize()},Workflow.prototype.dispose=function(){this.detachScrollEventListener(),this.process$.complete(),this.workflowSubscription.unsubscribe(),this.itemsSubscription.unsubscribe(),this.scroller.dispose()},Workflow.prototype.finalize=function(){},Workflow}(),UiScrollComponent=function(){function UiScrollComponent(changeDetector,elementRef){this.changeDetector=changeDetector,this.elementRef=elementRef}return UiScrollComponent.prototype.ngOnInit=function(){this.workflow=new Workflow(this)},UiScrollComponent.prototype.ngOnDestroy=function(){this.workflow.dispose()},UiScrollComponent.decorators=[{type:core.Component,args:[{selector:"[ui-scroll]",changeDetection:core.ChangeDetectionStrategy.OnPush,template:'<div data-padding-backward></div><div\n  *ngFor="let item of items"\n  [attr.data-sid]="item.nodeId"\n  [style.position]="item.invisible ? \'fixed\' : null"\n  [style.left]="item.invisible ? \'-99999px\' : null"\n><ng-template\n  [ngTemplateOutlet]="template"\n  [ngTemplateOutletContext]="{\n    $implicit: item.data,\n    index: item.$index,\n    odd: item.$index % 2,\n    even: !(item.$index % 2)\n }"\n></ng-template></div><div data-padding-forward></div>'}]}],UiScrollComponent.ctorParameters=function(){return[{type:core.ChangeDetectorRef},{type:core.ElementRef}]},UiScrollComponent}(),UiScrollDirective=function(){function UiScrollDirective(templateRef,viewContainer,resolver){this.templateRef=templateRef,this.viewContainer=viewContainer,this.resolver=resolver}return Object.defineProperty(UiScrollDirective.prototype,"uiScrollOf",{set:function(datasource){this.datasource=datasource},enumerable:!0,configurable:!0}),UiScrollDirective.prototype.ngOnInit=function(){var templateView=this.templateRef.createEmbeddedView({}),compFactory=this.resolver.resolveComponentFactory(UiScrollComponent),componentRef=this.viewContainer.createComponent(compFactory,void 0,this.viewContainer.injector,[templateView.rootNodes]);componentRef.instance.datasource=this.datasource,componentRef.instance.template=this.templateRef,componentRef.instance.version="1.0.1"},UiScrollDirective.decorators=[{type:core.Directive,args:[{selector:"[uiScroll][uiScrollOf]"}]}],UiScrollDirective.ctorParameters=function(){return[{type:core.TemplateRef},{type:core.ViewContainerRef},{type:core.ComponentFactoryResolver}]},UiScrollDirective.propDecorators={uiScrollOf:[{type:core.Input}]},UiScrollDirective}(),UiScrollModule=function(){function UiScrollModule(){}return UiScrollModule.decorators=[{type:core.NgModule,args:[{declarations:[UiScrollComponent,UiScrollDirective],imports:[common.CommonModule],entryComponents:[UiScrollComponent],exports:[UiScrollDirective],providers:[]}]}],UiScrollModule}();
/**
     * @license ngx-ui-scroll
     * MIT license
     */exports.UiScrollModule=UiScrollModule,exports.Datasource=Datasource,exports.a=UiScrollComponent,exports.b=UiScrollDirective,Object.defineProperty(exports,"__esModule",{value:!0})});