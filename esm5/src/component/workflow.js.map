{"version":3,"file":"workflow.js","sourceRoot":"","sources":["../../../src/component/workflow.ts"],"names":[],"mappings":";;;;AAAA,OAAO,EAAgB,eAAe,EAAE,MAAM,MAAM,CAAC;AAGrD,OAAO,EAAE,QAAQ,EAAE,MAAM,YAAY,CAAC;AACtC,OAAO,EAAE,OAAO,EAAE,aAAa,IAAI,MAAM,EAAkB,MAAM,oBAAoB,CAAC;AACtF,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,KAAK,EAAE,SAAS,EAAE,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,GAAG,EAAE,MAAM,mBAAmB,CAAC;AAEvH;IAYE,kBAAY,OAA0B;QAAtC,iBAeC;QAdC,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACzE,IAAI,CAAC,QAAQ,GAAG,IAAI,eAAe,CAAC,mBAAgB;YAClD,OAAO,EAAE,OAAO,CAAC,IAAI;YACrB,MAAM,EAAE,MAAM,CAAC,KAAK;SACrB,EAAA,CAAC,CAAC;QACH,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;QACpB,IAAI,CAAC,eAAe,GAAG,UAAA,KAAK,IAAI,OAAA,MAAM,CAAC,GAAG,CAAC,KAAI,CAAC,QAAQ,EAAE,EAAE,KAAK,OAAA,EAAE,CAAC,EAApC,CAAoC,CAAC;QAErE,IAAI,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,EAAE;YAC1C,UAAU,CAAC,cAAM,OAAA,KAAI,CAAC,IAAI,EAAE,EAAX,CAAW,EAAE,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAAC,CAAC;SACvE;aAAM;YACL,IAAI,CAAC,IAAI,EAAE,CAAC;SACb;IACH,CAAC;;;;IAED,uBAAI;;;IAAJ;QACE,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;QACrB,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;QAC5C,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;;;;IAED,gCAAa;;;IAAb;QAAA,iBAMC;;YALO,QAAQ,GAAG,IAAI,CAAC,QAAQ;QAC9B,QAAQ,CAAC,MAAM,CAAC,GAAG,CAAC,cAAM,OAAA,mDAAmD,EAAnD,CAAmD,CAAC,CAAC;QAC/E,IAAI,CAAC,iBAAiB,GAAG,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,UAAA,KAAK,IAAI,OAAA,KAAI,CAAC,OAAO,CAAC,KAAK,GAAG,KAAK,EAA1B,CAA0B,CAAC,CAAC;QAC/F,IAAI,CAAC,oBAAoB,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC7E,IAAI,CAAC,uBAAuB,EAAE,CAAC;IACjC,CAAC;;;;IAED,0CAAuB;;;IAAvB;;YACM,gBAAgB,GAAG,KAAK;QAC5B,IAAI;YACF,MAAM,CAAC,gBAAgB,CACrB,MAAM,EAAE,mBAAoC,EAAE,EAAA,EAAE,MAAM,CAAC,cAAc,CAAC,EAAE,EAAE,SAAS,EAAE;gBACnF,GAAG,EAAE,cAAM,OAAA,gBAAgB,GAAG,IAAI,EAAvB,CAAuB;aACnC,CAAC,CACH,CAAC;SACH;QAAC,OAAO,GAAG,EAAE;SACb;QACD,IAAI,CAAC,kBAAkB,GAAG,gBAAgB,CAAC,CAAC,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC;QACxE,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,kBAAkB,CAAC,gBAAgB,CACxD,QAAQ,EAAE,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,kBAAkB,CACxD,CAAC;IACJ,CAAC;;;;IAED,4CAAyB;;;IAAzB;QACE,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,kBAAkB,CAAC,mBAAmB,CAC3D,QAAQ,EAAE,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,kBAAkB,CACxD,CAAC;IACJ,CAAC;;;;;IAED,0BAAO;;;;IAAP,UAAQ,IAAoB;;YACpB,QAAQ,GAAG,IAAI,CAAC,QAAQ;QACtB,IAAA,oBAAM,EAAE,sBAAO;QACvB,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QACtC,IAAI,MAAM,KAAK,MAAM,CAAC,KAAK,EAAE;YAC3B,GAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YAC3B,OAAO;SACR;QACD,QAAQ,IAAI,CAAC,OAAO,EAAE;YACpB,KAAK,OAAO,CAAC,IAAI;gBACf,IAAI,MAAM,KAAK,MAAM,CAAC,KAAK,EAAE;oBAC3B,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACpB;gBACD,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;iBAC9B;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,MAAM;gBACjB,IAAI,MAAM,KAAK,MAAM,CAAC,KAAK,EAAE;oBAC3B,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;iBAC/B;gBACD,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACpB;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,MAAM;gBACjB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,IAAI,CAAC,CAAC,OAAO,IAAI,OAAO,CAAC,UAAU,CAAC,EAAE;wBACpC,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;qBAC7B;yBAAM;wBACL,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;qBAC9B;iBACF;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,KAAK;gBAChB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,QAAQ,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACxB;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,QAAQ;gBACnB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,GAAG,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACnB;gBACD,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACrB;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,KAAK;gBAChB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,SAAS,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACzB;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,SAAS;gBACpB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACtB;gBACD,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,GAAG,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACnB;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,MAAM;gBACjB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,IAAI,QAAQ,CAAC,QAAQ,CAAC,QAAQ,EAAE;wBAC9B,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;qBACtB;yBAAM;wBACL,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;qBACpB;iBACF;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,IAAI;gBACf,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACtB;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,MAAM;gBACjB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,GAAG,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;iBACnB;gBACD,MAAM;YACR,KAAK,OAAO,CAAC,GAAG;gBACd,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,IAAI,OAAO,IAAI,OAAO,CAAC,UAAU,EAAE;wBACjC,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;qBACtB;yBAAM;wBACL,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;qBAC9B;iBACF;gBACD,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,EAAE;oBAC1B,IAAI,CAAC,IAAI,EAAE,CAAC;iBACb;gBACD,MAAM;SACT;IACH,CAAC;;;;;IAED,+BAAY;;;;IAAZ,UAAa,cAA8B;QACzC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;IACrC,CAAC;;;;IAED,uBAAI;;;IAAJ;QACU,IAAA,2BAAK;QACb,IAAI,CAAC,UAAU,EAAE,CAAC;QAClB,KAAK,CAAC,kBAAkB,GAAG,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;QAC/C,KAAK,CAAC,sBAAsB,GAAG,KAAK,CAAC;QACrC,KAAK,CAAC,eAAe,GAAG,KAAK,CAAC;QAC9B,IAAI,KAAK,CAAC,WAAW,CAAC,WAAW,KAAK,IAAI,EAAE;YAC1C,KAAK,CAAC,SAAS,GAAG,KAAK,CAAC;SACzB;QACD,IAAI,CAAC,QAAQ,EAAE,CAAC;IAClB,CAAC;;;;IAED,0BAAO;;;IAAP;QACE,IAAI,CAAC,yBAAyB,EAAE,CAAC;QACjC,IAAI,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC;QACzB,IAAI,CAAC,oBAAoB,CAAC,WAAW,EAAE,CAAC;QACxC,IAAI,CAAC,iBAAiB,CAAC,WAAW,EAAE,CAAC;QACrC,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;;;;IAED,2BAAQ;;;IAAR;IACA,CAAC;IAEH,eAAC;AAAD,CAAC,AA1LD,IA0LC;;;;IAxLC,4BAAmB;;IACnB,4BAA0C;;IAC1C,8BAAmB;;IAEnB,2BAAoC;;IACpC,mCAAwC;;IACxC,qCAAwC;;IACxC,wCAA2C;;IAC3C,sCAAgC","sourcesContent":["import { Subscription, BehaviorSubject } from 'rxjs';\n\nimport { UiScrollComponent } from '../ui-scroll.component';\nimport { Scroller } from './scroller';\nimport { Process, ProcessStatus as Status, ProcessSubject } from './interfaces/index';\nimport { Init, Scroll, Reload, Start, PreFetch, Fetch, PostFetch, Render, Clip, Adjust, End } from './processes/index';\n\nexport class Workflow {\n\n  scroller: Scroller;\n  process$: BehaviorSubject<ProcessSubject>;\n  cyclesDone: number;\n\n  readonly context: UiScrollComponent;\n  readonly onScrollHandler: EventListener;\n  private itemsSubscription: Subscription;\n  private workflowSubscription: Subscription;\n  private scrollEventOptions: any;\n\n  constructor(context: UiScrollComponent) {\n    this.context = context;\n    this.scroller = new Scroller(this.context, this.callWorkflow.bind(this));\n    this.process$ = new BehaviorSubject(<ProcessSubject>{\n      process: Process.init,\n      status: Status.start\n    });\n    this.cyclesDone = 0;\n    this.onScrollHandler = event => Scroll.run(this.scroller, { event });\n\n    if (this.scroller.settings.initializeDelay) {\n      setTimeout(() => this.init(), this.scroller.settings.initializeDelay);\n    } else {\n      this.init();\n    }\n  }\n\n  init() {\n    this.scroller.init();\n    this.scroller.logger.stat('initialization');\n    this.initListeners();\n  }\n\n  initListeners() {\n    const scroller = this.scroller;\n    scroller.logger.log(() => `uiScroll Workflow listeners are being initialized`);\n    this.itemsSubscription = scroller.buffer.$items.subscribe(items => this.context.items = items);\n    this.workflowSubscription = this.process$.subscribe(this.process.bind(this));\n    this.initScrollEventListener();\n  }\n\n  initScrollEventListener() {\n    let passiveSupported = false;\n    try {\n      window.addEventListener(\n        'test', <EventListenerOrEventListenerObject>{}, Object.defineProperty({}, 'passive', {\n          get: () => passiveSupported = true\n        })\n      );\n    } catch (err) {\n    }\n    this.scrollEventOptions = passiveSupported ? { passive: false } : false;\n    this.scroller.viewport.scrollEventElement.addEventListener(\n      'scroll', this.onScrollHandler, this.scrollEventOptions\n    );\n  }\n\n  detachScrollEventListener() {\n    this.scroller.viewport.scrollEventElement.removeEventListener(\n      'scroll', this.onScrollHandler, this.scrollEventOptions\n    );\n  }\n\n  process(data: ProcessSubject) {\n    const scroller = this.scroller;\n    const { status, payload } = data;\n    this.scroller.logger.logProcess(data);\n    if (status === Status.error) {\n      End.run(scroller, payload);\n      return;\n    }\n    switch (data.process) {\n      case Process.init:\n        if (status === Status.start) {\n          Init.run(scroller);\n        }\n        if (status === Status.next) {\n          Start.run(scroller, payload);\n        }\n        break;\n      case Process.reload:\n        if (status === Status.start) {\n          Reload.run(scroller, payload);\n        }\n        if (status === Status.next) {\n          Init.run(scroller);\n        }\n        break;\n      case Process.scroll:\n        if (status === Status.next) {\n          if (!(payload && payload.keepScroll)) {\n            Init.run(scroller, payload);\n          } else {\n            Start.run(scroller, payload);\n          }\n        }\n        break;\n      case Process.start:\n        if (status === Status.next) {\n          PreFetch.run(scroller);\n        }\n        break;\n      case Process.preFetch:\n        if (status === Status.done) {\n          End.run(scroller);\n        }\n        if (status === Status.next) {\n          Fetch.run(scroller);\n        }\n        break;\n      case Process.fetch:\n        if (status === Status.next) {\n          PostFetch.run(scroller);\n        }\n        break;\n      case Process.postFetch:\n        if (status === Status.next) {\n          Render.run(scroller);\n        }\n        if (status === Status.done) {\n          End.run(scroller);\n        }\n        break;\n      case Process.render:\n        if (status === Status.next) {\n          if (scroller.settings.infinite) {\n            Adjust.run(scroller);\n          } else {\n            Clip.run(scroller);\n          }\n        }\n        break;\n      case Process.clip:\n        if (status === Status.next) {\n          Adjust.run(scroller);\n        }\n        break;\n      case Process.adjust:\n        if (status === Status.done) {\n          End.run(scroller);\n        }\n        break;\n      case Process.end:\n        if (status === Status.next) {\n          if (payload && payload.keepScroll) {\n            Scroll.run(scroller);\n          } else {\n            Start.run(scroller, payload);\n          }\n        }\n        if (status === Status.done) {\n          this.done();\n        }\n        break;\n    }\n  }\n\n  callWorkflow(processSubject: ProcessSubject) {\n    this.process$.next(processSubject);\n  }\n\n  done() {\n    const { state } = this.scroller;\n    this.cyclesDone++;\n    state.workflowCycleCount = this.cyclesDone + 1;\n    state.isInitialWorkflowCycle = false;\n    state.workflowPending = false;\n    if (state.scrollState.scrollTimer === null) {\n      state.isLoading = false;\n    }\n    this.finalize();\n  }\n\n  dispose() {\n    this.detachScrollEventListener();\n    this.process$.complete();\n    this.workflowSubscription.unsubscribe();\n    this.itemsSubscription.unsubscribe();\n    this.scroller.dispose();\n  }\n\n  finalize() {\n  }\n\n}\n"]}