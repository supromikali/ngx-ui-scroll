{"version":3,"file":"state.js","sourceRoot":"","sources":["../../../../src/component/classes/state.ts"],"names":[],"mappings":"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","sourcesContent":["import { BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  State as IState,\r\n  ProcessRun,\r\n  ItemAdapter,\r\n  WindowScrollState as IWindowScrollState,\r\n  ScrollState as IScrollState,\r\n  SyntheticScroll as ISyntheticScroll\r\n} from '../interfaces/index';\r\nimport { FetchModel } from './fetch';\r\nimport { Settings } from './settings';\r\nimport { Logger } from './logger';\r\nimport { itemAdapterEmpty } from './adapter';\r\n\r\nclass WindowScrollState implements IWindowScrollState {\r\n  positionToUpdate: number;\r\n  delta: number;\r\n\r\n  constructor() {\r\n    this.reset();\r\n  }\r\n\r\n  reset() {\r\n    this.delta = 0;\r\n    this.positionToUpdate = 0;\r\n  }\r\n}\r\n\r\nclass ScrollState implements IScrollState {\r\n  firstScroll: boolean;\r\n  firstScrollTime: number;\r\n  lastScrollTime: number;\r\n  scrollTimer: number | null;\r\n  workflowTimer: number | null;\r\n  scroll: boolean;\r\n  keepScroll: boolean;\r\n  window: IWindowScrollState;\r\n\r\n  constructor() {\r\n    this.window = new WindowScrollState();\r\n    this.reset();\r\n  }\r\n\r\n  reset() {\r\n    this.firstScroll = false;\r\n    this.firstScrollTime = 0;\r\n    this.lastScrollTime = 0;\r\n    this.scrollTimer = null;\r\n    this.workflowTimer = null;\r\n    this.scroll = false;\r\n    this.keepScroll = false;\r\n    this.window.reset();\r\n  }\r\n}\r\n\r\nclass SyntheticScroll implements ISyntheticScroll {\r\n  position: number | null;\r\n  positionBefore: number | null;\r\n  delta: number;\r\n  time: number;\r\n  readyToReset: boolean;\r\n\r\n  constructor() {\r\n    this.reset(null);\r\n  }\r\n\r\n  reset(position: number | null = null) {\r\n    this.position = position;\r\n    this.positionBefore = null;\r\n    this.delta = 0;\r\n    this.time = 0;\r\n    this.readyToReset = false;\r\n  }\r\n}\r\n\r\nexport class State implements IState {\r\n\r\n  protected settings: Settings;\r\n  protected logger: Logger;\r\n\r\n  initTime: number;\r\n  innerLoopCount: number;\r\n  isInitialLoop: boolean;\r\n  workflowCycleCount: number;\r\n  isInitialWorkflowCycle: boolean;\r\n  countDone: number;\r\n\r\n  startIndex: number;\r\n  fetch: FetchModel;\r\n  clip: boolean;\r\n  clipCall: number;\r\n  lastPosition: number;\r\n  preFetchPosition: number;\r\n  preAdjustPosition: number;\r\n  sizeBeforeRender: number;\r\n  fwdPaddingBeforeRender: number;\r\n  bwdPaddingAverageSizeItemsCount: number;\r\n\r\n  scrollState: IScrollState;\r\n  syntheticScroll: ISyntheticScroll;\r\n\r\n  loopPendingSource: BehaviorSubject<boolean>;\r\n  workflowPendingSource: BehaviorSubject<boolean>;\r\n  isLoadingSource: BehaviorSubject<boolean>;\r\n  firstVisibleSource: BehaviorSubject<ItemAdapter>;\r\n  lastVisibleSource: BehaviorSubject<ItemAdapter>;\r\n  firstVisibleWanted: boolean;\r\n  lastVisibleWanted: boolean;\r\n\r\n  get loopPending(): boolean {\r\n    return this.loopPendingSource.getValue();\r\n  }\r\n\r\n  set loopPending(value: boolean) {\r\n    if (this.loopPending !== value) {\r\n      this.loopPendingSource.next(value);\r\n    }\r\n  }\r\n\r\n  get workflowPending(): boolean {\r\n    return this.workflowPendingSource.getValue();\r\n  }\r\n\r\n  set workflowPending(value: boolean) {\r\n    if (this.workflowPending !== value) {\r\n      this.workflowPendingSource.next(value);\r\n    }\r\n  }\r\n\r\n  get isLoading(): boolean {\r\n    return this.isLoadingSource.getValue();\r\n  }\r\n\r\n  set isLoading(value: boolean) {\r\n    if (this.isLoading !== value) {\r\n      this.isLoadingSource.next(value);\r\n    }\r\n  }\r\n\r\n  get firstVisibleItem(): ItemAdapter {\r\n    return this.firstVisibleSource.getValue();\r\n  }\r\n\r\n  set firstVisibleItem(item: ItemAdapter) {\r\n    if (this.firstVisibleItem.$index !== item.$index) {\r\n      this.firstVisibleSource.next(item);\r\n    }\r\n  }\r\n\r\n  get lastVisibleItem(): ItemAdapter {\r\n    return this.lastVisibleSource.getValue();\r\n  }\r\n\r\n  set lastVisibleItem(item: ItemAdapter) {\r\n    if (this.lastVisibleItem.$index !== item.$index) {\r\n      this.lastVisibleSource.next(item);\r\n    }\r\n  }\r\n\r\n  get time(): number {\r\n    return Number(new Date()) - this.initTime;\r\n  }\r\n\r\n  constructor(settings: Settings, logger: Logger) {\r\n    this.settings = settings;\r\n    this.logger = logger;\r\n    this.initTime = Number(new Date());\r\n    this.innerLoopCount = 0;\r\n    this.isInitialLoop = false;\r\n    this.workflowCycleCount = 1;\r\n    this.isInitialWorkflowCycle = false;\r\n    this.countDone = 0;\r\n\r\n    this.setCurrentStartIndex(settings.startIndex);\r\n    this.fetch = new FetchModel();\r\n    this.clip = false;\r\n    this.clipCall = 0;\r\n    this.sizeBeforeRender = 0;\r\n    this.fwdPaddingBeforeRender = 0;\r\n    this.bwdPaddingAverageSizeItemsCount = 0;\r\n\r\n    this.scrollState = new ScrollState();\r\n    this.syntheticScroll = new SyntheticScroll();\r\n\r\n    this.loopPendingSource = new BehaviorSubject<boolean>(false);\r\n    this.workflowPendingSource = new BehaviorSubject<boolean>(false);\r\n    this.isLoadingSource = new BehaviorSubject<boolean>(false);\r\n    this.firstVisibleSource = new BehaviorSubject<ItemAdapter>(itemAdapterEmpty);\r\n    this.lastVisibleSource = new BehaviorSubject<ItemAdapter>(itemAdapterEmpty);\r\n    this.firstVisibleWanted = false;\r\n    this.lastVisibleWanted = false;\r\n  }\r\n\r\n  startLoop(options?: ProcessRun) {\r\n    this.loopPending = true;\r\n    this.innerLoopCount++;\r\n    this.fetch.reset();\r\n    this.clip = false;\r\n    if (options) {\r\n      this.scrollState.scroll = options.scroll || false;\r\n    }\r\n    this.scrollState.keepScroll = false;\r\n  }\r\n\r\n  endLoop() {\r\n    this.loopPending = false;\r\n    this.countDone++;\r\n    this.isInitialLoop = false;\r\n  }\r\n\r\n  setCurrentStartIndex(newStartIndex: any) {\r\n    const { startIndex, minIndex, maxIndex } = this.settings;\r\n    let index = Number(newStartIndex);\r\n    if (isNaN(index)) {\r\n      this.logger.log(() =>\r\n        `fallback startIndex to settings.startIndex (${startIndex}) because ${newStartIndex} is not a number`);\r\n      index = startIndex;\r\n    }\r\n    if (index < minIndex) {\r\n      this.logger.log(() => `setting startIndex to settings.minIndex (${minIndex}) because ${index} < ${minIndex}`);\r\n      index = minIndex;\r\n    }\r\n    if (index > maxIndex) {\r\n      this.logger.log(() => `setting startIndex to settings.maxIndex (${maxIndex}) because ${index} > ${maxIndex}`);\r\n      index = maxIndex;\r\n    }\r\n    this.startIndex = index;\r\n  }\r\n\r\n}\r\n"]}